(function(e,m){typeof exports=="object"&&typeof module<"u"?module.exports=m(require("react"),require("lucide-react")):typeof define=="function"&&define.amd?define(["react","lucide-react"],m):(e=typeof globalThis<"u"?globalThis:e||self,e.Video2Manual_Generator=m(e.React,e.Lucide))})(this,(function(e,m){"use strict";function ae({initialSteps:le=[]}){const[N,ie]=e.useState(null),[x,C]=e.useState(le),[y,oe]=e.useState(null),[j,X]=e.useState(!1),[W,F]=e.useState(null),[de,V]=e.useState(!1),[v,A]=e.useState(!1),[f,_]=e.useState(null),[h,D]=e.useState(null),[ce,J]=e.useState("default"),[G,q]=e.useState(null),p=e.useRef(null),K=e.useRef(null),Q=e.useRef(null),E=e.useRef(null);e.useRef(null),e.useEffect(()=>{if(window.JSZip)V(!0);else{const t=document.createElement("script");t.src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js",t.async=!0,t.onload=()=>V(!0),document.body.appendChild(t)}},[]);const H=e.useCallback(()=>{if(!p.current)return null;const t=document.createElement("canvas");t.width=p.current.videoWidth,t.height=p.current.videoHeight;const n=t.getContext("2d");return n?(n.drawImage(p.current,0,0,t.width,t.height),t.toDataURL("image/png")):null},[]),z=e.useCallback(async t=>{const n=x.find(r=>r.step_id===t);if(!(!n||!p.current)){if(oe(t),A(!1),n.capturedImage){F(n.capturedImage);return}if(N){p.current.currentTime=n.timestamp_seconds,await new Promise(i=>setTimeout(i,300));const r=H();F(r),C(i=>i.map(s=>s.step_id===t?{...s,previewImage:r||void 0}:s))}}},[x,N,H]);e.useEffect(()=>{N&&x.length>0&&y===null&&z(x[0].step_id)},[N,x,y,z]);const w=10,me=(t,n)=>{t.stopPropagation(),q(null),z(n),setTimeout(()=>{A(!0)},100)};e.useEffect(()=>{if(v&&y&&E.current){const t=x.find(n=>n.step_id===y);if(t&&E.current){const{width:n,height:r}=E.current.getBoundingClientRect(),[i,s,c,l]=t.ui_coordinates;l>0&&c>0?_({x:s/1e3*n,y:i/1e3*r,width:(l-s)/1e3*n,height:(c-i)/1e3*r}):_({x:n*.25,y:r*.4,width:n*.5,height:r*.2})}}},[v,y,x]);const R=(t,n,r)=>{if(!r)return null;const{x:i,y:s,width:c,height:l}=r;return Math.abs(t-i)<=w&&Math.abs(n-s)<=w?"nw":Math.abs(t-(i+c))<=w&&Math.abs(n-s)<=w?"ne":Math.abs(t-i)<=w&&Math.abs(n-(s+l))<=w?"sw":Math.abs(t-(i+c))<=w&&Math.abs(n-(s+l))<=w?"se":t>i+w&&t<i+c-w&&n>s+w&&n<s+l-w?"move":null},ue=t=>{if(!v||!E.current)return;const n=E.current.getBoundingClientRect(),r=t.clientX-n.left,i=t.clientY-n.top,s=R(r,i,f);s&&f?D({type:s==="move"?"move":"resize",handle:s,startX:r,startY:i,initialRect:{...f}}):(_({x:r,y:i,width:0,height:0}),D({type:"create",startX:r,startY:i,initialRect:null}))},ge=t=>{if(!v||!E.current)return;const n=E.current.getBoundingClientRect(),r=t.clientX-n.left,i=t.clientY-n.top,s=Math.max(0,Math.min(r,n.width)),c=Math.max(0,Math.min(i,n.height));if(h){if(h.type==="create")_({x:Math.min(h.startX,s),y:Math.min(h.startY,c),width:Math.abs(s-h.startX),height:Math.abs(c-h.startY)});else if(h.type==="move"&&h.initialRect){const l=s-h.startX,g=c-h.startY;_({...h.initialRect,x:h.initialRect.x+l,y:h.initialRect.y+g})}else if(h.type==="resize"&&h.initialRect){const{initialRect:l,handle:g}=h;let a={...l};const o=s-h.startX,u=c-h.startY;g==="se"?(a.width=l.width+o,a.height=l.height+u):g==="sw"?(a.x=l.x+o,a.width=l.width-o,a.height=l.height+u):g==="ne"?(a.y=l.y+u,a.width=l.width+o,a.height=l.height-u):g==="nw"&&(a.x=l.x+o,a.y=l.y+u,a.width=l.width-o,a.height=l.height-u),a.width<0&&(a.x+=a.width,a.width=Math.abs(a.width)),a.height<0&&(a.y+=a.height,a.height=Math.abs(a.height)),_(a)}}else{const l=R(r,i,f);J(l==="move"?"move":l==="nw"||l==="se"?"nwse-resize":l==="ne"||l==="sw"?"nesw-resize":"crosshair")}},ee=()=>{D(null)},he=()=>{if(y&&f&&E.current){const{width:t,height:n}=E.current.getBoundingClientRect(),r=Math.round(f.x/t*1e3),i=Math.round(f.y/n*1e3),s=Math.round((f.x+f.width)/t*1e3),c=Math.round((f.y+f.height)/n*1e3),l=a=>Math.max(0,Math.min(1e3,a));let g=W;if(!g&&p.current){const a=document.createElement("canvas");a.width=p.current.videoWidth,a.height=p.current.videoHeight;const o=a.getContext("2d");o&&(o.drawImage(p.current,0,0),g=a.toDataURL("image/png"))}C(a=>a.map(o=>o.step_id===y?{...o,ui_coordinates:[l(i),l(r),l(c),l(s)],status:"success",capturedImage:g||void 0}:o)),A(!1),_(null)}},te=async t=>{var i,s,c,l,g;const n=x.find(a=>a.step_id===t);if(!n)return;let r=n.capturedImage||n.previewImage;if(!r&&p.current&&(p.current.currentTime=n.timestamp_seconds,await new Promise(a=>setTimeout(a,300)),r=H()||void 0),!r){alert("画像の取得に失敗しました。動画を確認してください。");return}C(a=>a.map(o=>o.step_id===t?{...o,status:"analyzing"}:o));try{const a=r.split(",")[1],u=await fetch("https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({contents:[{parts:[{text:`
        Return JSON only. No markdown.
        Detect the bounding box of the UI element described by the user.
        Coordinate system: 0-1000 normalized [ymin, xmin, ymax, xmax].
        Schema: { "boxes": [ { "ymin": int, "xmin": int, "ymax": int, "xmax": int, "label": string } ] }
      `+`
Target: ${n.target_label}
Hint: ${n.visual_description}`},{inlineData:{mimeType:"image/png",data:a}}]}],generationConfig:{responseMimeType:"application/json"}})});if(!u.ok)throw new Error(`API Error: ${u.status}`);const $=(g=(l=(c=(s=(i=(await u.json()).candidates)==null?void 0:i[0])==null?void 0:s.content)==null?void 0:c.parts)==null?void 0:l[0])==null?void 0:g.text,M=JSON.parse($);if(M.boxes&&M.boxes.length>0){const S=M.boxes[0];C(k=>k.map(P=>P.step_id===t?{...P,ui_coordinates:[S.ymin,S.xmin,S.ymax,S.xmax],status:"success",capturedImage:r}:P))}else throw new Error("Not found")}catch(a){console.error(a),alert(`エラーが発生しました: ${a.message}`),C(o=>o.map(u=>u.step_id===t?{...u,status:"error"}:u))}},fe=async()=>{X(!0);for(const t of x)await z(t.step_id),await te(t.step_id),await new Promise(n=>setTimeout(n,800));X(!1)},xe=()=>{const t="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(x,null,2)),n=document.createElement("a");n.href=t,n.download="result.json",n.click()},pe=async t=>!t.capturedImage||!t.ui_coordinates?null:new Promise(n=>{const r=new Image;r.onload=()=>{const i=document.createElement("canvas");i.width=r.width,i.height=r.height;const s=i.getContext("2d");if(!s){n(null);return}s.drawImage(r,0,0);const[c,l,g,a]=t.ui_coordinates;if(a>0&&g>0){const o=l/1e3*r.width,u=c/1e3*r.height,T=(a-l)/1e3*r.width,$=(g-c)/1e3*r.height,M=Math.max(2,r.width*.0035),S=M*2;s.strokeStyle="#ef4444",s.lineWidth=M,s.beginPath(),s.roundRect?s.roundRect(o,u,T,$,S):s.rect(o,u,T,$),s.stroke();let k=`Step ${t.step_id}`;const P=12;let b=Math.max(16,r.width*.025);s.font=`bold ${b}px sans-serif`;let L=s.measureText(k),I=b*.6;const O=T,ne=L.width+I*2;if(ne>O){const Ee=O/ne;let se=Math.floor(b*Ee);if(se<P){k=`${t.step_id}`,b=Math.max(16,r.width*.025),I=b*.6,s.font=`bold ${b}px sans-serif`,L=s.measureText(k);const re=L.width+I*2;if(re>O){const Ne=O/re;b=Math.max(10,Math.floor(b*Ne))}}else b=se}s.font=`bold ${b}px sans-serif`,L=s.measureText(k),I=b*.6;const Y=L.width+I*2,B=b+I*2,we=u<r.height/2,Z=o+T/2-Y/2;let U;we?U=u+$+M:U=u-B-M,s.fillStyle="#ef4444",s.beginPath(),s.roundRect?s.roundRect(Z,U,Y,B,S):s.rect(Z,U,Y,B),s.fill(),s.fillStyle="white",s.textAlign="center",s.textBaseline="middle";const ye=Z+Y/2,ve=U+B/2;s.fillText(k,ye,ve+b*.05)}i.toBlob(o=>n(o),"image/png")},r.src=t.capturedImage}),be=async()=>{if(!window.JSZip||!de){alert("ZIPライブラリの準備中です。数秒待ってから再試行してください。");return}X(!0);try{const t=new window.JSZip,n=t.folder("images");let r=`# 操作マニュアル

自動生成された操作手順書です。

`;for(const l of x){if(r+=`### Step ${l.step_id} : ${l.target_label}
`,r+=`${l.instruction_text}

`,l.status==="success"&&l.capturedImage){const g=await pe(l);if(g){const a=`step${l.step_id}.png`;n==null||n.file(a,g),r+=`![Step ${l.step_id}](./images/${a})

`}}else r+=`> *(画像なし)*

`;r+=`---

`}t.file("manual.md",r);const i=await t.generateAsync({type:"blob"}),s=URL.createObjectURL(i),c=document.createElement("a");c.href=s,c.download="manual_package.zip",c.click(),URL.revokeObjectURL(s)}catch(t){console.error(t),alert("マニュアル作成中にエラーが発生しました。")}finally{X(!1)}},d=x.find(t=>t.step_id===y);return e.createElement("div",{className:"min-h-screen bg-gray-50 text-gray-900 font-sans flex flex-col"},e.createElement("video",{ref:p,src:N||void 0,className:"hidden",muted:!0,playsInline:!0}),e.createElement("input",{type:"file",accept:"video/*",ref:K,className:"hidden",onChange:t=>{var n;(n=t.target.files)!=null&&n[0]&&ie(URL.createObjectURL(t.target.files[0]))}}),e.createElement("input",{type:"file",accept:".json",ref:Q,className:"hidden",onChange:t=>{var n;if((n=t.target.files)!=null&&n[0]){const r=new FileReader;r.onload=i=>{var s;return C(JSON.parse((s=i.target)==null?void 0:s.result))},r.readAsText(t.target.files[0])}}}),e.createElement("header",{className:"bg-white border-b border-gray-200 px-4 py-3 flex items-center justify-between sticky top-0 z-20 shadow-sm"},e.createElement("div",{className:"flex items-center gap-2"},e.createElement("div",{className:"bg-blue-600 text-white p-1.5 rounded-lg"},e.createElement(m.Layout,{className:"w-5 h-5"})),e.createElement("h1",{className:"font-bold text-lg hidden sm:block"},"UIキャプチャ・スタジオ")),e.createElement("div",{className:"flex gap-2 relative"},!N&&e.createElement("button",{onClick:()=>{var t;return(t=K.current)==null?void 0:t.click()},className:"flex items-center gap-2 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium text-sm transition-colors"},e.createElement(m.Upload,{className:"w-4 h-4"})," 動画を選択"),N&&e.createElement(e.Fragment,null,e.createElement("button",{onClick:()=>{var t;return(t=Q.current)==null?void 0:t.click()},className:"p-2 text-gray-600 hover:bg-gray-100 rounded-lg border border-gray-200",title:"JSON読込"},e.createElement(m.FileJson,{className:"w-5 h-5"})),e.createElement("div",{className:"h-8 w-px bg-gray-300 mx-1"}),e.createElement("button",{onClick:xe,className:"flex items-center gap-2 px-3 py-2 bg-white hover:bg-gray-50 text-gray-700 border border-gray-300 rounded-lg font-medium text-sm transition-colors"},e.createElement(m.FileJson,{className:"w-4 h-4"})," ",e.createElement("span",{className:"hidden sm:inline"},"JSON")),e.createElement("button",{onClick:be,disabled:j,className:"flex items-center gap-2 px-4 py-2 bg-indigo-900 hover:bg-indigo-800 text-white rounded-lg font-medium text-sm transition-colors shadow-sm"},j?e.createElement(m.Loader2,{className:"w-4 h-4 animate-spin"}):e.createElement(m.BookOpen,{className:"w-4 h-4"}),e.createElement("span",null,"マニュアル保存 (ZIP)"))))),e.createElement("main",{className:"flex-1 flex flex-col md:flex-row overflow-hidden"},e.createElement("div",{className:"w-full md:w-80 bg-white border-b md:border-b-0 md:border-r border-gray-200 flex flex-col h-1/3 md:h-full shrink-0"},e.createElement("div",{className:"p-3 bg-gray-50 border-b border-gray-200 flex justify-between items-center"},e.createElement("span",{className:"text-xs font-bold text-gray-500 uppercase tracking-wider"},"Timeline Steps"),e.createElement("span",{className:"bg-gray-200 text-gray-600 text-xs px-2 py-0.5 rounded-full"},x.length)),e.createElement("div",{className:"flex-1 overflow-y-auto p-2 space-y-2"},x.map(t=>e.createElement("div",{key:t.step_id,className:`group relative rounded-xl border transition-all duration-200 ${y===t.step_id?"bg-blue-50 border-blue-200 shadow-sm ring-1 ring-blue-200":"bg-white border-gray-100 hover:bg-gray-50 hover:border-gray-200"}`},e.createElement("button",{onClick:()=>z(t.step_id),className:"w-full text-left p-3 flex items-start gap-3"},e.createElement("div",{className:`mt-0.5 w-6 h-6 rounded-full flex items-center justify-center text-[10px] font-bold shrink-0 ${t.status==="success"?"bg-green-100 text-green-700":t.status==="error"?"bg-red-100 text-red-700":y===t.step_id?"bg-blue-600 text-white":"bg-gray-100 text-gray-500"}`},t.step_id),e.createElement("div",{className:"min-w-0 flex-1"},e.createElement("div",{className:"flex justify-between items-center mb-0.5"},e.createElement("span",{className:"text-xs font-medium text-gray-900 truncate"},t.target_label),e.createElement("span",{className:"text-[10px] text-gray-400 font-mono"},t.timestamp_str)),e.createElement("p",{className:"text-[10px] text-gray-500 line-clamp-1"},t.instruction_text))),e.createElement("div",{className:"absolute top-2 right-2"},e.createElement("button",{onClick:n=>{n.stopPropagation(),q(G===t.step_id?null:t.step_id)},className:"p-1 rounded-full text-gray-400 hover:text-gray-600 hover:bg-gray-200"},e.createElement(m.MoreVertical,{className:"w-4 h-4"})),G===t.step_id&&e.createElement("div",{className:"absolute right-0 mt-1 w-48 bg-white rounded-lg shadow-lg border border-gray-200 z-50 overflow-hidden animate-in fade-in zoom-in-95 duration-100"},e.createElement("button",{onClick:n=>me(n,t.step_id),className:"w-full text-left px-4 py-2.5 text-sm text-gray-700 hover:bg-blue-50 hover:text-blue-600 flex items-center gap-2"},e.createElement(m.Crop,{className:"w-4 h-4"}),"手動で座標を修正")))))),e.createElement("div",{className:"p-4 border-t border-gray-200 bg-gray-50"},e.createElement("button",{onClick:fe,disabled:j||!N,className:"w-full py-2.5 bg-white border border-gray-300 hover:border-blue-300 hover:text-blue-600 text-gray-700 rounded-lg text-sm font-bold shadow-sm transition-all flex items-center justify-center gap-2 disabled:opacity-50"},j?e.createElement(m.Loader2,{className:"w-4 h-4 animate-spin"}):e.createElement(m.Sparkles,{className:"w-4 h-4 text-yellow-500"})," AI一括解析"))),e.createElement("div",{className:"flex-1 bg-gray-100 flex flex-col h-2/3 md:h-full relative overflow-y-auto"},N?e.createElement("div",{className:"p-4 md:p-8 flex flex-col gap-6 max-w-5xl mx-auto w-full h-full"},e.createElement("div",{className:"bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden flex-1 flex flex-col min-h-0 relative"},e.createElement("div",{className:"p-4 border-b border-gray-100 flex justify-between items-center"},e.createElement("div",{className:"flex items-center gap-2"},e.createElement(m.Image,{className:"w-4 h-4 text-gray-400"}),e.createElement("span",{className:"text-sm font-bold text-gray-700"},"Preview: ",d==null?void 0:d.timestamp_str),v&&e.createElement("span",{className:"bg-orange-100 text-orange-600 text-xs px-2 py-0.5 rounded-full font-bold animate-pulse"},"Manual Edit Mode")),d&&!v&&e.createElement("button",{onClick:()=>te(d.step_id),disabled:j,className:"text-xs bg-blue-50 text-blue-700 px-3 py-1 rounded-full font-medium hover:bg-blue-100 transition-colors"},d.status==="analyzing"?"解析中...":"AI再解析"),v&&e.createElement("div",{className:"flex gap-2"},e.createElement("button",{onClick:()=>{A(!1),_(null)},className:"text-xs bg-gray-100 text-gray-600 px-3 py-1.5 rounded-lg font-bold hover:bg-gray-200 transition-colors flex items-center gap-1"},e.createElement(m.X,{className:"w-3 h-3"})," キャンセル"),e.createElement("button",{onClick:he,className:"text-xs bg-blue-600 text-white px-3 py-1.5 rounded-lg font-bold hover:bg-blue-700 transition-colors flex items-center gap-1 shadow-sm"},e.createElement(m.Save,{className:"w-3 h-3"})," 変更を保存"))),e.createElement("div",{className:"flex-1 bg-[url('https://www.transparenttextures.com/patterns/grid-me.png')] bg-gray-50 relative flex items-center justify-center overflow-hidden p-4 select-none",onMouseDown:ue,onMouseMove:ge,onMouseUp:ee,onMouseLeave:ee,style:{cursor:ce}},W?e.createElement("div",{className:"relative shadow-xl max-w-full max-h-full inline-block"},e.createElement("img",{ref:E,src:W,alt:"Step Preview",className:"max-w-full max-h-full object-contain rounded pointer-events-none select-none block",draggable:!1}),!v&&(d==null?void 0:d.ui_coordinates)&&d.ui_coordinates[2]>0&&e.createElement("div",{className:"absolute border-red-500 shadow-[0_0_0_2px_rgba(255,255,255,0.2)] pointer-events-none flex items-center justify-center",style:{top:`${d.ui_coordinates[0]/10}%`,left:`${d.ui_coordinates[1]/10}%`,height:`${(d.ui_coordinates[2]-d.ui_coordinates[0])/10}%`,width:`${(d.ui_coordinates[3]-d.ui_coordinates[1])/10}%`,borderWidth:"3px",borderRadius:"6px"}},e.createElement("div",{className:"bg-red-500 text-white px-2 py-0.5 rounded text-[10px] font-bold shadow-sm whitespace-nowrap overflow-hidden max-w-full text-ellipsis"},"Step ",d.step_id)),v&&f&&e.createElement("div",{className:"absolute border-2 border-white z-50 shadow-[0_0_0_9999px_rgba(0,0,0,0.5)] cursor-move",style:{left:f.x,top:f.y,width:f.width,height:f.height}},e.createElement("div",{className:"absolute -top-1.5 -left-1.5 w-3 h-3 bg-white border border-black cursor-nwse-resize"}),e.createElement("div",{className:"absolute -top-1.5 -right-1.5 w-3 h-3 bg-white border border-black cursor-nesw-resize"}),e.createElement("div",{className:"absolute -bottom-1.5 -left-1.5 w-3 h-3 bg-white border border-black cursor-nesw-resize"}),e.createElement("div",{className:"absolute -bottom-1.5 -right-1.5 w-3 h-3 bg-white border border-black cursor-nwse-resize"}))):e.createElement("div",{className:"flex flex-col items-center gap-2 text-gray-400"},e.createElement(m.Loader2,{className:"w-8 h-8 animate-spin"}),e.createElement("span",{className:"text-sm"},"Generating Preview...")))),d&&!v&&e.createElement("div",{className:"bg-white rounded-xl p-6 shadow-sm border border-gray-200 shrink-0"},e.createElement("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6"},e.createElement("div",null,e.createElement("label",{className:"text-xs font-bold text-gray-400 uppercase tracking-wider mb-1 block"},"Target UI Element"),e.createElement("div",{className:"flex items-center gap-2 text-lg font-bold text-gray-800"},e.createElement(m.MousePointer2,{className:"w-5 h-5 text-blue-500"}),d.target_label),e.createElement("p",{className:"text-sm text-gray-600 mt-2 bg-gray-50 p-3 rounded-lg border border-gray-100"},d.instruction_text)),e.createElement("div",null,e.createElement("label",{className:"text-xs font-bold text-gray-400 uppercase tracking-wider mb-1 block"},"AI Hint / Status"),e.createElement("p",{className:"text-sm text-gray-600 bg-yellow-50 p-3 rounded-lg border border-yellow-100 text-yellow-800 flex gap-2 items-start"},e.createElement(m.Brain,{className:"w-4 h-4 shrink-0 mt-0.5"}),d.visual_description),e.createElement("div",{className:"mt-4 flex items-center gap-2"},e.createElement("div",{className:`text-xs px-2 py-1 rounded font-mono border ${d.status==="success"?"bg-green-50 border-green-200 text-green-700":"bg-gray-100 border-gray-200 text-gray-500"}`},"Status: ",d.status||"Pending"),e.createElement("div",{className:"text-xs font-mono text-gray-400"},"Coords: [",d.ui_coordinates.join(","),"]")))))):e.createElement("div",{className:"flex-1 flex flex-col items-center justify-center text-gray-400 p-8"},e.createElement("div",{className:"w-20 h-20 bg-gray-200 rounded-full flex items-center justify-center mb-4"},e.createElement(m.Upload,{className:"w-8 h-8 text-gray-400"})),e.createElement("p",{className:"text-lg font-medium text-gray-500"},"動画ファイルを読み込んで開始")))))}return ae}));
